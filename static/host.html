<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Starboard Directory</title>
    <!-- jQuery and jQuery Mobile -->
    <link rel="stylesheet" href="/static/css/jquery.mobile-1.3.1.min.css" />
    <link rel="icon" type="image/ico" href="/static/images/favicon.ico" />
    <link rel="stylesheet" href="/static/css/directory.css" />
  </head>

  <body>
    <div data-role="page" id="page1">
      <div data-role="header" class="hbar">
        <h3>Starboard Directory</h3>
      </div>
      <div id="console">
        <p class="ahead">Registered Controllers</p>
        <ul id="controller-list"></ul>
      </div>

      <script src="/static/js/socket.io.js"></script>
      <script src="/static/js/d3.v3.min.js" charset="utf-8"></script>

      <!-- Code for socket.io and device orientation handling -->
      <script>
        var controllers;

        // need to force socket.io to use a relative path in case we are proxied
        var sock = io.connect("/", {path: location.pathname + "socket.io"});
        sock.on("state-changed", function(msg) {
            if (msg.addr == "_controllers") {
               controllers = msg.data;
               drawDirectory();
            }
        })

        d3.json("controllers", function(err, data) {
            console.log(data);
            if (err) console.warn(err);
            else {
                controllers = data;
                drawDirectory();
            }
        });

        function drawDirectory() {
            var el = d3.select("#controller-list").selectAll("li")
                .data(controllers);

            el.enter()
                .append("li")
                .append("a")
                .attr("href", function(d) { return "/device/" + d + "/"})
                .text(function(d) { return d});

            el.exit().remove();
        }
        </script>
  </body>
</html>
